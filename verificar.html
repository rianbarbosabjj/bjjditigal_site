<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifica√ß√£o de Certificado - BJJ Digital</title>
  
  <!-- Fonte Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Design System BJJ Digital */
    :root {
      --cor-fundo: #0e2d26;
      --cor-card: #113830;
      --cor-texto: #ffffff;
      --cor-destaque: #FFD700; /* Dourado */
      --cor-borda: #078B6C;    /* Verde */
      --cor-erro: #ff4b4b;
      --cor-erro-bg: #2d0e0e;
      --sombra: 0 10px 30px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--cor-fundo);
      background-image: radial-gradient(circle at 50% 0%, #1a4d40 0%, var(--cor-fundo) 80%);
      color: var(--cor-texto);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .verify-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }
    
    .logo { width: 140px; margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    
    h1 { color: var(--cor-destaque); font-size: 1.5rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
    .subtitle { font-size: 0.9rem; color: #a0c0b5; margin-bottom: 30px; text-align: center; }

    /* --- √ÅREA DE BUSCA MANUAL --- */
    .search-box {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--cor-borda);
        border-radius: 12px;
        padding: 15px;
        width: 100%;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }
    
    .search-input {
        flex: 1;
        background: #091f1a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 10px;
        color: #fff;
        font-family: monospace;
        font-size: 1rem;
        outline: none;
        text-transform: uppercase;
    }
    .search-input:focus { border-color: var(--cor-destaque); }
    
    .search-btn {
        background: var(--cor-borda);
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }
    .search-btn:hover { background: #056853; }

    /* --- CART√ÉO --- */
    .box {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      border-radius: 20px;
      padding: 40px 30px;
      width: 100%;
      box-shadow: var(--sombra);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--cor-borda), var(--cor-destaque), var(--cor-borda)); }
    
    .valid-icon { font-size: 4rem; margin-bottom: 15px; display: block; animation: popIn 0.5s; }
    .status-text { font-size: 1.5rem; color: #4CAF50; font-weight: 700; margin-bottom: 25px; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    
    .info-group { margin-bottom: 15px; border-bottom: 1px solid #1f4239; padding-bottom: 10px; text-align: left; }
    .info-group:last-child { border-bottom: none; }
    
    .label { color: #aaa; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .value { color: #fff; font-size: 1.1rem; font-weight: 600; word-wrap: break-word; }
    .highlight { color: var(--cor-destaque); font-size: 1.3rem; }

    .codigo-container { margin-top: 25px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; border: 1px dashed #444; text-align: left; }
    .codigo { color: var(--cor-destaque); font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1em; word-break: break-all; }

    /* ERRO */
    .box.error { border-color: var(--cor-erro); background-color: var(--cor-erro-bg); }
    .box.error::before { background: var(--cor-erro); }
    .error-title { color: var(--cor-erro); font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; }
    .error-code { font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; color: #ffaaaa; margin: 15px 0; display: inline-block; border: 1px dashed var(--cor-erro); }

    .loading-spinner { font-size: 2rem; animation: spin 1s infinite linear; margin-bottom: 15px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .hidden { display: none; }
    footer { margin-top: 40px; font-size: 0.8rem; color: #5c7a70; }
  </style>
</head>
<body>

  <div class="verify-container">
    <img src="imagens/logo.png" alt="BJJ Digital Logo" class="logo" onerror="this.style.display='none'">
    <h1>Valida√ß√£o de Certificado</h1>
    <p class="subtitle">Sistema de Autenticidade Oficial</p>

    <!-- BUSCA MANUAL -->
    <div class="search-box">
        <input type="text" id="input-codigo" class="search-input" placeholder="Digite o c√≥digo..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="verificarManual()">Verificar</button>
    </div>

    <!-- 1. LOADING -->
    <div id="loading" class="box hidden" style="border-color: #555;">
      <div class="loading-spinner">‚è≥</div>
      <p style="color: #ccc;">Consultando base de dados...</p>
    </div>

    <!-- 2. SUCESSO -->
    <div id="success-box" class="box hidden">
      <div class="valid-title status-text">‚úÖ Certificado V√°lido</div>
      
      <div class="info-group"><div class="label">Aluno</div><div class="value" id="res-nome"></div></div>
      <div class="info-group"><div class="label">Aprovado a Faixa</div><div class="value highlight" id="res-faixa"></div></div>
      <div style="display: flex; justify-content: space-between;">
         <div style="text-align: left;"><div class="label">Data</div><div class="value" id="res-data"></div></div>
         <div style="text-align: right;"><div class="label">Nota</div><div class="value" id="res-nota"></div></div>
      </div>
      <div class="codigo-container">
         <div class="label" style="margin-bottom:5px;">C√≥digo</div>
         <div class="codigo" id="res-codigo"></div>
      </div>
    </div>

    <!-- 3. ERRO -->
    <div id="error-box" class="box error hidden">
      <div class="error-title">‚ùå N√£o Encontrado</div>
      <p>O c√≥digo informado n√£o consta em nossa base de dados oficial.</p>
      <div class="error-code" id="res-codigo-erro"></div>
      <p style="font-size: 0.8rem; color: #aaa;">Verifique se o c√≥digo foi digitado corretamente.</p>
      <p id="debug-msg" style="color: orange; font-size: 0.7rem; margin-top: 10px; display: none;"></p>
    </div>

    <footer>&copy; 2025 BJJ Digital Platform</footer>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // üî• CONFIGURA√á√ÉO CERTA
    const firebaseConfig = {
      apiKey: "AIzaSyAZkYYkXkOcXWTDmABwD5XmKWWSibHmrRQ",
      authDomain: "bjj-digital.firebaseapp.com",
      projectId: "bjj-digital",
      storageBucket: "bjj-digital.firebasestorage.app",
      messagingSenderId: "120230340536",
      appId: "1:120230340536:web:3abed82ebb5b6e952a514d",
      measurementId: "G-MYHRYD3DD3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üìå Fun√ß√£o exposta para o bot√£o
    window.verificarManual = function () {
        const input = document.getElementById("input-codigo");
        const codigo = input.value.trim().toUpperCase();

        if (codigo.length < 3) {
            alert("C√≥digo inv√°lido. Digite pelo menos 3 caracteres.");
            return;
        }

        const newUrl = `${window.location.pathname}?codigo=${codigo}`;
        window.history.pushState({}, '', newUrl);

        buscarNoBanco(codigo);
    };

    // Permite Enter
    window.handleEnter = function (e) {
        if (e.key === "Enter") window.verificarManual();
    };

    // üöÄ AUTO-CARREGAMENTO SE O C√ìDIGO ESTIVER NA URL
    async function init() {
        const params = new URLSearchParams(window.location.search);
        const codigoUrl = params.get("codigo") || params.get("code");

        if (codigoUrl) {
            document.getElementById("input-codigo").value = codigoUrl.toUpperCase();
            buscarNoBanco(codigoUrl.toUpperCase());
        }
    }

    // üîç FUN√á√ÉO PRINCIPAL DE BUSCA
    async function buscarNoBanco(codigo) {
        const elLoading = document.getElementById("loading");
        const elSuccess = document.getElementById("success-box");
        const elError = document.getElementById("error-box");
        const elDebug = document.getElementById("debug-msg");

        elLoading.classList.remove("hidden");
        elSuccess.classList.add("hidden");
        elError.classList.add("hidden");
        elDebug.style.display = "none";

        try {
            // Toler√¢ncia ao nome do campo: codigo ou codigo_verificacao
            const q1 = query(collection(db, "resultados"), where("codigo", "==", codigo), limit(1));
            const q2 = query(collection(db, "resultados"), where("codigo_verificacao", "==", codigo), limit(1));

            let querySnapshot = await getDocs(q1);
            if (querySnapshot.empty) querySnapshot = await getDocs(q2);

            elLoading.classList.add("hidden");

            if (!querySnapshot.empty) {
                const doc = querySnapshot.docs[0].data();

                document.getElementById("res-nome").innerText =
                    (doc.usuario || doc.nome || "N√ÉO INFORMADO").toUpperCase();

                document.getElementById("res-faixa").innerText =
                    (doc.faixa || doc.graduacao || "SEM INFORMA√á√ÉO").toUpperCase();

                document.getElementById("res-nota").innerText =
                    doc.pontuacao ? doc.pontuacao + "%" : "--";

                document.getElementById("res-codigo").innerText = codigo;

                if (doc.data?.seconds) {
                    const date = new Date(doc.data.seconds * 1000);
                    document.getElementById("res-data").innerText = date.toLocaleDateString("pt-BR");
                } else {
                    document.getElementById("res-data").innerText = "--";
                }

                elSuccess.classList.remove("hidden");
            } else {
                document.getElementById("res-codigo-erro").innerText = codigo;
                elError.classList.remove("hidden");
            }
        } catch (e) {
            console.error("üî• ERRO FIREBASE:", e.message);

            elLoading.classList.add("hidden");
            document.getElementById("res-codigo-erro").innerText = "Erro de conex√£o";
            elDebug.style.display = "block";
            elDebug.innerText = "Erro: " + e.message;
            elError.classList.remove("hidden");
        }
    }

    init();
</script>
</body>
</html>

