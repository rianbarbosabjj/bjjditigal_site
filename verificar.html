
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="imagens/logo.png">
  <title>Verificação de Certificado - BJJ Digital</title>
  
  <!-- Fonte Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Design System BJJ Digital */
    :root {
      --cor-fundo: #0e2d26;
      --cor-card: #113830;
      --cor-texto: #ffffff;
      --cor-destaque: #FFD700; /* Dourado */
      --cor-borda: #078B6C;    /* Verde */
      --cor-erro: #ff4b4b;
      --cor-erro-bg: #2d0e0e;
      --sombra: 0 10px 30px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--cor-fundo);
      background-image: radial-gradient(circle at 50% 0%, #1a4d40 0%, var(--cor-fundo) 80%);
      color: var(--cor-texto);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .verify-container {
        width: 100%;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Logo */
    .logo {
      width: 140px;
      margin-bottom: 20px;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }

    /* Títulos */
    h1 { 
      color: var(--cor-destaque); 
      font-size: 1.5rem;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #a0c0b5;
      margin-bottom: 30px;
      text-align: center;
    }

    /* Box Principal */
    .box {
      background-color: var(--cor-card);
      border: 1px solid var(--cor-borda);
      border-radius: 20px;
      padding: 40px 30px;
      width: 100%;
      box-shadow: var(--sombra);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    /* Barra superior colorida */
    .box::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, var(--cor-borda), var(--cor-destaque), var(--cor-borda));
    }

    /* Estado de Sucesso */
    .valid-title {
      color: #4CAF50;
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 20px;
      text-transform: uppercase;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Lista de Dados */
    .data-list {
      text-align: left;
      margin-top: 20px;
    }

    .data-item {
      margin-bottom: 15px;
      border-bottom: 1px solid #1f4239;
      padding-bottom: 8px;
    }

    .data-item:last-child { border-bottom: none; }

    .data-label {
      color: #aaa;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .data-value {
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      word-wrap: break-word;
    }

    .highlight-value {
      color: var(--cor-destaque);
      font-size: 1.3rem;
    }

    /* Estado de Erro */
    .box.error {
      border-color: var(--cor-erro);
      background-color: var(--cor-erro-bg);
    }
    
    .box.error::before {
      background: var(--cor-erro);
    }

    .error-title {
      color: var(--cor-erro);
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .error-code {
      font-family: monospace;
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 5px;
      color: #ffaaaa;
      margin: 15px 0;
      display: inline-block;
      border: 1px dashed var(--cor-erro);
    }

    /* Loading */
    .loading-spinner {
      font-size: 2rem;
      animation: spin 1s infinite linear;
      margin-bottom: 15px;
    }
    
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .hidden { display: none; }

    footer {
      margin-top: 40px;
      font-size: 0.8rem;
      color: #5c7a70;
    }
  </style>
</head>
<body>

  <div class="verify-container">
    
    <!-- Se a imagem não carregar, ela some sem quebrar o layout -->
    <img src="imagem/logo.png" alt="BJJ Digital" class="logo" onerror="this.style.display='none'">

    <h1>Validação de Certificado</h1>
    <p class="subtitle">Sistema de Autenticidade Oficial</p>
<div style="width: 100%; margin-bottom: 20px;">
  <input 
    id="input-manual" 
    type="text" 
    placeholder="Digite o código do certificado..." 
    style="
      width: 100%; 
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--cor-borda);
      background: #0b241e;
      color: #fff;
      font-size: 1rem;
      outline: none;
      text-transform: uppercase;
    "
    onkeypress="handleEnter(event)"
  >

  <button 
    onclick="verificarManual()" 
    style="
      margin-top: 10px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: var(--cor-borda);
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    "
  >
    Verificar Certificado
  </button>
</div>
    <!-- 1. LOADING -->
    <div id="loading" class="box" style="border-color: #555;">
      <div class="loading-spinner">⏳</div>
      <p style="color: #ccc;">Consultando base de dados...</p>
    </div>

    <!-- 2. SUCESSO (O que você pediu) -->
    <div id="success-box" class="box hidden">
      <div class="valid-title">✅ Certificado Válido</div>
      
      <div class="data-list">
        
        <div class="data-item">
          <div class="data-label">Nome do Aluno</div>
          <div class="data-value" id="res-nome"></div>
        </div>

        <div class="data-item">
          <div class="data-label">Aprovado a Faixa</div>
          <div class="data-value highlight-value" id="res-faixa"></div>
        </div>

        <div class="data-item">
          <div class="data-label">Data do Exame</div>
          <div class="data-value" id="res-data"></div>
        </div>

        <div class="data-item">
          <div class="data-label">Código</div>
          <div class="data-value" id="res-codigo" style="font-family: monospace; letter-spacing: 1px;"></div>
        </div>

      </div>
    </div>

    <!-- 3. ERRO (Mantido como estava) -->
    <div id="error-box" class="box error hidden">
      <div class="error-title">❌ Não Encontrado</div>
      <p>O código informado não consta em nossa base de dados oficial.</p>
      <div class="error-code" id="res-codigo-erro"></div>
      <p style="font-size: 0.8rem; color: #aaa;">Verifique se o link foi digitado corretamente.</p>
      
      <!-- Debug para te ajudar a saber se é erro de chave -->
      <p id="debug-msg" style="color: orange; font-size: 0.7rem; margin-top: 10px; display: none;"></p>
    </div>

    <footer>
      &copy; 2025 BJJ Digital Platform
    </footer>

  </div>

  <!-- FIREBASE SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

   
    const firebaseConfig = {
      apiKey: "AIzaSyAZkYYkXkOcXWTDmABwD5XmKWWSibHmrRQ",
      authDomain: "bjj-digital.firebaseapp.com",
      projectId: "bjj-digital",
      storageBucket: "bjj-digital.firebasestorage.app",
      messagingSenderId: "120230340536", 
      appId: "1:120230340536:web:3abed82ebb5b6e952a514d",
      measurementId: "G-MYHRYD3DD3"	  	 
    };

    // Inicializa
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app, "bjj-digital");

    async function verificar() {
        // Captura parâmetros da URL (?codigo=XYZ ou ?code=XYZ para garantir)
        const params = new URLSearchParams(window.location.search);
        const codigo = params.get("codigo") || params.get("code");
        
        const elLoading = document.getElementById("loading");
        const elSuccess = document.getElementById("success-box");
        const elError = document.getElementById("error-box");
        const elDebug = document.getElementById("debug-msg");

        if (!codigo) {
            elLoading.classList.add("hidden");
            elError.classList.remove("hidden");
            document.getElementById("res-codigo-erro").innerText = "Nenhum código informado";
            return;
        }

        try {
            // Busca no Firestore (Coleção: resultados)
            const q = query(collection(db, "resultados"), where("codigo_verificacao", "==", codigo));
            const querySnapshot = await getDocs(q);

            elLoading.classList.add("hidden");

            if (!querySnapshot.empty) {
                // SUCESSO: Encontrou o documento
                const doc = querySnapshot.docs[0].data();
                
                // Preenche os dados
                document.getElementById("res-nome").innerText = doc.usuario ? doc.usuario.toUpperCase() : "N/A";
                document.getElementById("res-faixa").innerText = doc.faixa ? doc.faixa.toUpperCase() : "N/A";
                document.getElementById("res-codigo").innerText = codigo;
                
                // Formata data
                if(doc.data && doc.data.seconds) {
                    const date = new Date(doc.data.seconds * 1000);
                    // Formata dia/mês/ano
                    document.getElementById("res-data").innerText = date.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById("res-data").innerText = "-";
                }

                elSuccess.classList.remove("hidden");
            } else {
                // ERRO: Não achou no banco
                document.getElementById("res-codigo-erro").innerText = codigo;
                elError.classList.remove("hidden");
            }

        } catch (e) {
            // ERRO TÉCNICO (Provavelmente falta de chave ou permissão)
            console.error("Erro de conexão:", e);
            elLoading.classList.add("hidden");
            document.getElementById("res-codigo-erro").innerText = codigo;
            elError.classList.remove("hidden");
            
            // Mostra mensagem técnica discreta para ajudar no debug
            elDebug.style.display = "block";
            elDebug.innerText = "Erro técnico: " + e.message;
        }
    }
window.handleEnter = function(e) {
  if (e.key === "Enter") verificarManual();
}

// Função para capturar o código digitado
window.verificarManual = function() {
  const input = document.getElementById("input-manual");
  const codigo = input.value.trim().toUpperCase();

  if (!codigo) {
    alert("Digite um código para verificar.");
    return;
  }

  // Atualiza a URL para manter histórico e permitir compartilhamento
  const newUrl = `${window.location.pathname}?codigo=${codigo}`;
  window.history.pushState({}, '', newUrl);

  verificar(); // chama a função original
}
  </script>
</body>
</html>

